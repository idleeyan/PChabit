<?xml version="1.0" encoding="UTF-8" ?>
<Page
    x:Class="PChabit.App.Views.BackupManagementPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <ScrollViewer Padding="24">
        <StackPanel Spacing="24">
            <TextBlock
                FontSize="28"
                FontWeight="SemiBold"
                Text="备份管理" />

            <Border
                Padding="16"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="12">
                <StackPanel Spacing="16">
                    <TextBlock
                        FontSize="16"
                        FontWeight="SemiBold"
                        Text="备份设置" />

                    <Grid ColumnSpacing="12">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <TextBox
                            Grid.Column="0"
                            Header="备份路径"
                            Text="{x:Bind ViewModel.BackupPath, Mode=TwoWay}"
                            IsReadOnly="True" />
                        <Button
                            Grid.Column="1"
                            Content="浏览..."
                            VerticalAlignment="Bottom"
                            Click="BrowseBackupPath_Click" />
                    </Grid>

                    <Grid ColumnSpacing="24">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <ToggleSwitch
                            Grid.Column="0"
                            Header="自动备份"
                            IsOn="{x:Bind ViewModel.AutoBackupEnabled, Mode=TwoWay}" />
                        <NumberBox
                            Grid.Column="1"
                            Header="备份间隔（小时）"
                            Value="{x:Bind ViewModel.AutoBackupIntervalHours, Mode=TwoWay}"
                            Minimum="1"
                            Maximum="24"
                            SpinButtonPlacementMode="Inline" />
                    </Grid>

                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <Button
                            Content="立即备份"
                            Style="{StaticResource AccentButtonStyle}"
                            Command="{x:Bind ViewModel.CreateBackupCommand}"
                            IsEnabled="{x:Bind ViewModel.IsBackingUp, Mode=OneWay, Converter={StaticResource InverseBooleanConverter}}" />
                        <ProgressBar
                            Width="200"
                            Value="{x:Bind ViewModel.BackupProgress, Mode=OneWay}"
                            Visibility="{x:Bind ViewModel.IsBackingUp, Mode=OneWay, Converter={StaticResource BooleanToVisibilityConverter}}" />
                        <TextBlock
                            Text="{x:Bind ViewModel.BackupStatus, Mode=OneWay}"
                            VerticalAlignment="Center" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <Border
                Padding="16"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="12">
                <StackPanel Spacing="16">
                    <TextBlock
                        FontSize="16"
                        FontWeight="SemiBold"
                        Text="数据清理" />

                    <Grid ColumnSpacing="24">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <NumberBox
                            Grid.Column="0"
                            Header="数据保留天数"
                            Value="{x:Bind ViewModel.DataRetentionDays, Mode=TwoWay}"
                            Minimum="30"
                            Maximum="365"
                            SpinButtonPlacementMode="Inline" />
                        <ToggleSwitch
                            Grid.Column="1"
                            Header="清理前归档"
                            IsOn="{x:Bind ViewModel.ArchiveBeforeCleanup, Mode=TwoWay}" />
                    </Grid>

                    <StackPanel Orientation="Horizontal" Spacing="12">
                        <Button
                            Content="清理旧数据"
                            Command="{x:Bind ViewModel.CleanupDataCommand}"
                            IsEnabled="{x:Bind ViewModel.IsCleaningUp, Mode=OneWay, Converter={StaticResource InverseBooleanConverter}}" />
                        <TextBlock
                            Text="{x:Bind ViewModel.CleanupStatus, Mode=OneWay}"
                            VerticalAlignment="Center" />
                    </StackPanel>
                </StackPanel>
            </Border>

            <Border
                Padding="16"
                Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="12">
                <StackPanel Spacing="16">
                    <TextBlock
                        FontSize="16"
                        FontWeight="SemiBold"
                        Text="备份历史" />

                    <ListView
                        ItemsSource="{x:Bind ViewModel.Backups, Mode=OneWay}"
                        SelectionMode="None"
                        MaxHeight="400">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="8" ColumnSpacing="12">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0">
                                        <TextBlock FontWeight="SemiBold">
                                            <Run Text="{Binding CreatedAt}" />
                                        </TextBlock>
                                        <TextBlock
                                            Text="{Binding FilePath}"
                                            FontSize="12"
                                            Foreground="Gray" />
                                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,4,0,0">
                                            <TextBlock FontSize="12" Foreground="Gray">
                                                <Run Text="大小:" />
                                                <Run Text="{Binding FileSize}" />
                                            </TextBlock>
                                            <TextBlock FontSize="12" Foreground="Gray">
                                                <Run Text="记录数:" />
                                                <Run Text="{Binding RecordCount}" />
                                            </TextBlock>
                                            <TextBlock FontSize="12" Foreground="Gray">
                                                <Run Text="{Binding IsAutomatic}" />
                                            </TextBlock>
                                        </StackPanel>
                                    </StackPanel>

                                    <Button
                                        Grid.Column="1"
                                        Content="恢复"
                                        Tag="{Binding}"
                                        Click="RestoreBackup_Click" />
                                    <Button
                                        Grid.Column="2"
                                        Content="删除"
                                        Tag="{Binding}"
                                        Click="DeleteBackup_Click" />
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </StackPanel>
            </Border>
        </StackPanel>
    </ScrollViewer>
</Page>
