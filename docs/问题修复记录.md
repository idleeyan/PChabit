# PChabit 问题修复记录

> 创建日期: 2026-02-13  
> 最后更新: 2026-02-14

本文档记录开发过程中遇到的问题、尝试的解决方案和最终修复方法。

---

## 待解决问题

目前无待解决问题。

---

## 修复统计

| 日期 | 问题数量 | 已解决 | 待解决 |
|------|---------|--------|--------|
| 2026-02-13 | 23 | 23 | 0 |
| 2026-02-14 | 10 | 10 | 0 |
| 2026-02-15 | 1 | 1 | 0 |

---

## 历史修复摘要

### 2026-02-13 修复的问题 (23个)

| # | 问题 | 解决方案 |
|---|------|---------|
| 1 | 数据未被正确记录 | 配置依赖注入、实现 DataCollectionService |
| 2 | 应用程序名称不正确 | 修改 AssemblyName 为 PChabit |
| 3 | 缺少事件定义 | 修正事件订阅代码 |
| 4 | 属性名称不匹配 | 统一使用正确的属性名称 |
| 5 | App.Current 访问问题 | 添加类型转换 |
| 6 | Suspending 事件不存在 | 移除相关代码 |
| 7 | Dictionary 类型不匹配 | 简化键盘数据收集 |
| 8 | 数据显示为空 | 修复 ViewModel 生命周期和 DI |
| 9 | 发布后程序无反应 | 禁用 PublishTrimmed/PublishSingleFile |
| 10 | 导出页面 UI 显示覆盖 | 添加 Grid.RowDefinitions |
| 11 | Dashboard 显示模拟数据 | 改用数据绑定 |
| 12 | 统计卡片不可点击 | 创建 DetailDialog 弹窗 |
| 13 | 时间线页面使用模拟数据 | 改用数据绑定 |
| 14 | 缺少应用统计页面 | 创建 AppStatsPage |
| 15 | 后台应用模式功能 | 实现 IBackgroundAppSettings |
| 16 | 网页访问详情不完整 | 添加 WebDetailItem 和分类功能 |
| 17 | 网页交互数据未收集 | 增强 WebMonitor 消息解析 |
| 18 | 程序不再记录新数据 | 修复 Win32 委托 GC 问题 |
| 19 | 数据库架构不匹配 | 添加架构迁移方法 |
| 20 | 打开新程序导致卡死 | 使用 Channel 异步处理 |
| 21 | 数据分析页面使用假数据 | 改用数据绑定 |
| 22 | 缺少按键详情页面 | 创建 KeyboardDetailsPage |
| 23 | 仪表盘网页访问详情无数据 | 功能已实现，需安装浏览器扩展 |

### 2026-02-14 修复的问题 (9个)

| # | 问题 | 解决方案 |
|---|------|---------|
| 24 | 浏览器扩展连接状态问题 | 改进消息处理和重连逻辑 |
| 25 | 设置页面功能无效 | 实现 ISettingsService |
| 26 | XAML 编译器错误 | 切换到 .NET 9 SDK |
| 27 | 网页访问记录未正确保存 | 修复时区不匹配、添加断开连接事件 |
| 28 | XamlCompiler.exe 编译错误 | 更新开发环境后使用 Visual Studio IDE 发布成功 |
| 29 | Visual Studio 项目显示"不兼容" | 修复类库项目的目标框架（从 net8.0-windows10.0.26100.0 改为 net8.0） |
| 30 | MSBuild 任务加载失败 | 清理 Visual Studio 缓存和 bin/obj 目录 |
| 31 | Tai.App.csproj MSIX 配置过多导致错误 | 简化项目文件，移除所有 MSIX 相关配置 |
| 32 | IDbContextFactory 未注册导致应用统计页面闪退 | 在服务配置中添加 AddDbContextFactory 注册 |

---

## 问题详细记录

### 问题 28：XamlCompiler.exe 编译错误（SDK WorkloadAutoImportPropsLocator 缺失）

**发现日期**: 2026-02-14  
**解决日期**: 2026-02-14  
**状态**: 已解决  
**严重程度**: 高（影响发布）

**问题描述**:
在使用 `dotnet publish` 命令发布 Tai.App 项目时，XamlCompiler.exe 报错退出，错误代码 1。错误信息显示缺少 Microsoft.NET.Sdk.WorkloadAutoImportPropsLocator。

**尝试过的解决方案**:
1. 切换 .NET SDK 版本（8.0.418 ↔ 9.0.311）
2. 切换 Windows App SDK 版本（1.5.240227000 ↔ 1.6.* ↔ 1.8.*）
3. 安装 .NET 6.0 运行时
4. 创建 runtimeconfig.json 配置文件
5. 设置 MSBuildSDKsPath 环境变量
6. 使用 Visual Studio Developer Command Prompt
7. 清理 bin/obj 目录并重新构建

**最终解决方案**:
更新开发环境后，使用 **Visual Studio IDE** 而不是命令行 `dotnet publish` 命令进行发布，成功完成。

**验证结果**:
- `publish` 目录包含完整的 258 个文件
- Views 目录下所有 XAML 文件已编译为 .xbf 格式
- 可执行文件 `PChabit.exe` 可正常运行

**经验总结**:
对于 WinUI 3 项目，当命令行发布遇到 XamlCompiler 问题时，使用 Visual Studio IDE 进行发布通常是更可靠的选择。

---

### 问题 29：Visual Studio 项目显示"不兼容"

**发现日期**: 2026-02-14  
**解决日期**: 2026-02-14  
**状态**: 已解决  
**严重程度**: 高（影响项目加载）

**问题描述**:
在 Visual Studio 中打开 Tai.sln 解决方案时，Tai.Core、Tai.Infrastructure、Tai.Application、Tai.Tests 项目显示为"不兼容"状态，无法正常加载。

**原因分析**:
这些类库项目错误地使用了 `net8.0-windows10.0.26100.0` 目标框架。这个框架只适用于 WinUI 3 应用项目（Tai.App），普通类库项目应该使用标准的 `net8.0` 目标框架。

**尝试过的解决方案**:
1. 检查项目文件是否存在
2. 确认项目代码完整
3. 识别目标框架配置错误

**最终解决方案**:
修改以下项目文件的目标框架：
- `Tai.Core.csproj`: `net8.0-windows10.0.26100.0` → `net8.0`
- `Tai.Infrastructure.csproj`: `net8.0-windows10.0.26100.0` → `net8.0`
- `Tai.Application.csproj`: `net8.0-windows10.0.26100.0` → `net8.0`
- `Tai.Tests.csproj`: `net8.0-windows10.0.26100.0` → `net8.0`

同时移除了 Tai.Core.csproj 中不需要的 `Microsoft.Windows.SDK.BuildTools` 包引用和 `TargetPlatformMinVersion` 属性。

**验证结果**:
- 所有项目在 Visual Studio 中正常加载
- 不再显示"不兼容"状态

**经验总结**:
- WinUI 3 应用项目应使用 `netX.0-windowsXX.0.XXXXX.0` 目标框架
- 普通类库项目（非 WinUI 3 应用）应使用标准的 `netX.0` 目标框架
- 保持项目架构清晰：只有表示层（Tai.App）需要 Windows 特定的目标框架

---

### 问题 30：MSBuild 任务加载失败（Microsoft.Build.Packaging.Pri.Tasks）

**发现日期**: 2026-02-14  
**解决日期**: 2026-02-14  
**状态**: 已解决  
**严重程度**: 高（影响项目构建）

**问题描述**:
在 Visual Studio 中加载解决方案时，出现以下错误：
- 未能从程序集加载任务 "Microsoft.Build.Packaging.Pri.Tasks.ExpandPriContent"
- 未能从程序集加载任务 "Microsoft.Build.AppxPackage.RemovePayloadDuplicates"
- 系统找不到指定的文件

**原因分析**:
Visual Studio 的缓存和项目的临时文件（bin/obj）中残留了 MSIX 打包相关的配置，导致即使在项目文件中禁用了 MSIX 打包，Visual Studio 仍然尝试加载这些任务。

**尝试过的解决方案**:
1. 检查 Tai.App.csproj 中的 MSIX 相关配置
2. 确认所有 MSIX 相关设置都已禁用

**最终解决方案**:
清理以下内容：
1. 删除 `.vs` 文件夹（Visual Studio 解决方案缓存）
2. 删除所有项目的 `bin` 目录
3. 删除所有项目的 `obj` 目录

然后在 Visual Studio 中重新打开解决方案。

**验证结果**:
- Visual Studio 正常加载解决方案
- 不再出现 MSBuild 任务加载失败的错误

**经验总结**:
- 当 Visual Studio 出现奇怪的构建错误时，首先尝试清理缓存和临时文件
- 定期清理 `.vs`、`bin`、`obj` 文件夹可以避免很多奇怪的问题
- 清理后需要重新打开 Visual Studio 解决方案

---

### 问题 31：Tai.App.csproj MSIX 配置过多导致错误

**发现日期**: 2026-02-14  
**解决日期**: 2026-02-14  
**状态**: 已解决  
**严重程度**: 高（影响项目加载）

**问题描述**:
1. Visual Studio 加载 Tai.sln 时出现 MSBuild 任务加载失败错误
2. 错误信息涉及 `Microsoft.Build.Packaging.Pri.Tasks.ExpandPriContent` 和 `Microsoft.Build.AppxPackage.RemovePayloadDuplicates`
3. 使用 .NET 10.0 预览版 SDK 构建时也出现类似错误

**原因分析**:
Tai.App.csproj 中包含了太多 MSIX 打包相关的配置（虽然都设置为 false），导致 Visual Studio 和 MSBuild 仍然尝试加载 MSIX 相关的任务。

**尝试过的解决方案**:
1. 清理 `.vs`、`bin`、`obj` 文件夹
2. 禁用 EnableMsixTooling、WindowsPackageType 等 MSIX 相关属性
3. 移除 ProjectCapability Remove="Msix"

**最终解决方案**:
完全简化 Tai.App.csproj，移除所有 MSIX 相关配置：
- 移除：EnableMsixTooling、WindowsPackageType、GenerateAppInstallerFile、AppxAutoIncrementPackageRevision、AppxPackageSigningEnabled、GeneratePriResources、EnableXamlDiagnostics、AppxPackage、AppxBundle、UapAppxPackageBuildMode、_WinUI_DownsampledLayoutIgnore、_GenerateAppxManifestPackage、PublishProfile 等
- 保留：TargetFramework、TargetPlatformMinVersion、OutputType、UseWinUI、RuntimeIdentifiers 等必要配置
- 移除 ProjectCapability Remove="Msix"

**验证结果**:
- 项目文件更加简洁清晰
- 保留了 WinUI 3 应用的必要功能

**经验总结**:
- 对于 WinUI 3 非 MSIX 打包应用，只需要保留最基本的配置
- 过多的禁用配置可能反而会引起问题
- 保持项目文件简洁，只保留必要的属性

---

### 问题 32：IDbContextFactory 未注册导致应用统计页面闪退

**发现日期**: 2026-02-14  
**解决日期**: 2026-02-14  
**状态**: 已解决  
**严重程度**: 高（影响应用统计功能)

**问题描述**:
打开应用统计页面时，应用闪退。原因是 `CategoryService` 依赖 `IDbContextFactory<TaiDbContext>`，但服务配置中没有注册这个工厂。

**原因分析**:
1. `CategoryService` 构造函数注入 `IDbContextFactory<TaiDbContext>`
2. 在 `ServiceConfiguration.cs` 和 `ServiceCollectionExtensions.cs` 中只注册了 `DbContext`，没有注册 `DbContextFactory`
3. 当 `AppStatsViewModel` 尝试加载分类数据时，依赖注入失败

**尝试过的解决方案**:
1. 检查 `CategoryService` 的依赖
2. 磁认 `IDbContextFactory` 未注册
3. 检查服务配置文件

**最终解决方案**:
在以下文件中添加 `AddDbContextFactory` 注册：
1. `ServiceConfiguration.cs`:
```csharp
services.AddDbContextFactory<TaiDbContext>(options =>
    options.UseSqlite($"Data Source={databasePath}"));
```
2. `ServiceCollectionExtensions.cs`:
```csharp
services.AddDbContextFactory<TaiDbContext>(options =>
    options.UseSqlite($"Data Source={dbPath}"));
```

同时，在 `DatabaseInitializer.cs` 中添加了分类表的迁移代码，确保旧数据库可以正确升级

**验证结果**:
- 核心库 (Tai.Core, Tai.Infrastructure) 构建成功
- 应用统计页面不再闪退

**经验总结**:
- 使用 `IDbContextFactory` 时，必须确保在 DI 容器中注册
- 对于需要新表的现有数据库，需要添加迁移逻辑

---

### 问题 33：设置页面卡死且设置无法保存（多重问题）

**发现日期**: 2026-02-15  
**解决日期**: 2026-02-15  
**状态**: 已解决  
**严重程度**: 高（影响设置功能）

**问题描述**:
1. 点击设置页面时程序卡死
2. 设置项无法保存
3. 问题循环出现，修复一个导致另一个

**原因分析**:
此问题由多个根本原因导致：

1. **XAML 数据绑定问题**: WinUI 3 中 `{Binding}` 在 `Mode=TwoWay` 时可能无法正确触发属性变更通知
2. **PRI 文件未同步**: `PChabit.pri` 文件没有被复制到发布目录，导致 XAML 解析失败
3. **XBF 文件缓存**: 清理 `obj` 目录后需要完全重新构建

**尝试过的解决方案**:
1. 修改 ViewModel 属性类型（从对象改为字符串）
2. 添加 `UpdateSourceTrigger=PropertyChanged`
3. 将 CheckBox 改为 ToggleSwitch
4. 使用事件处理替代数据绑定
5. 完全清理 obj/bin 目录重新构建

**最终解决方案**:

1. **放弃数据绑定，使用事件处理**:
   - XAML 中移除所有 `{Binding}` 绑定
   - 使用 `x:Name` 标识控件
   - 在 code-behind 中使用 lambda 表达式动态添加事件处理
   - 添加 `_isLoading` 标志防止加载时触发事件

2. **确保 PRI 文件同步**:
   - 发布时必须复制 `bin\x64\Release\...\win-x64\PChabit.pri` 到发布目录
   - 此文件包含 XAML 资源索引，必须与 XBF 文件匹配

3. **SettingsViewModel 添加 SaveSetting 方法**:
```csharp
public void SaveSetting(string propertyName)
{
    switch (propertyName)
    {
        case "StartWithWindows":
            _settingsService.StartWithWindows = StartWithWindows;
            break;
        // ... 其他属性
    }
    _settingsService.Save();
}
```

4. **SettingsPage.xaml.cs 使用事件处理**:
```csharp
private void AddEventHandlers()
{
    StartWithWindowsSwitch.Toggled += (s, e) => 
        OnSettingChanged("StartWithWindows", StartWithWindowsSwitch.IsOn);
    // ... 其他控件
}

private void OnSettingChanged(string propertyName, object value)
{
    if (_isLoading) return;
    // 更新 ViewModel 并保存
    ViewModel.SaveSetting(propertyName);
}
```

**验证结果**:
- 设置页面正常加载
- 设置项可以正确保存

**预防措施**:
1. 发布脚本必须包含 PRI 文件复制步骤
2. WinUI 3 项目优先使用事件处理而非双向绑定
3. 修改 XAML 后必须完全重新构建

**经验总结**:
- WinUI 3 的数据绑定在某些情况下可能不可靠，事件处理更可靠
- PRI 文件是 WinUI 3 应用的重要组成部分，必须与 XBF 文件同步
- 发布流程需要包含所有资源文件的复制步骤
