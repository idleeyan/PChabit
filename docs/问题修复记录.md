# 问题修复记录

> 记录项目中遇到的问题及解决方案

---

## 2026-02-16: Sankey 图 JSON 数据传递失败

### 问题描述
应用流向页面数据加载成功（日志显示 2909 次切换，11 个应用），但图表不显示。

### 根因分析

**日志证据**:
```
[SankeyView] 数据序列化完成，节点数: 11, 链接数: 58
[SankeyView] 执行 JavaScript 渲染...
[SankeyView] JavaScript 执行结果: null
```

**问题定位**:
1. 使用 `JSON.parse('{escapedJson}')` 方式传递数据
2. 手动转义 JSON 字符串容易出错
3. 单引号包裹 JSON 在 JavaScript 中解析可能失败

### 解决方案

**使用 WebView2 的 `PostWebMessageAsJson` API**:
1. C# 端: 使用 `ChartWebView.CoreWebView2.PostWebMessageAsJson(json)` 发送 JSON
2. JavaScript 端: 监听 `window.chrome.webview.addEventListener('message', ...)` 接收数据
3. 避免手动转义，让 WebView2 处理 JSON 序列化

### 修改文件
- `src/Tai.App/Views/SankeyView.xaml.cs` - 改用 PostWebMessageAsJson
- `src/Tai.App/Assets/Sankey/sankey.html` - 添加 WebView 消息监听器

---

## 2026-02-16: Sankey 图 CoreWebView2 空引用异常

### 问题描述
修复 JSON 传递后，页面仍然空白，日志显示 `NullReferenceException`。

### 根因分析

**日志证据**:
```
[SankeyView] 数据序列化完成，节点数: 11, 链接数: 64, JSON长度: 9341
[ERR] [SankeyView] 刷新数据失败
System.NullReferenceException: Object reference not set to an instance of an object.
   at Tai.App.Views.SankeyView.RefreshDataAsync() in SankeyView.xaml.cs:line 123
```

**问题定位**:
1. XAML 中设置了 `Source="ms-appx-web:///Assets/Sankey/sankey.html"`
2. 这会在 `EnsureCoreWebView2Async()` 调用之前就开始导航
3. 导致 `CoreWebView2` 属性为 null
4. 调用 `PostWebMessageAsJson` 时抛出空引用异常

### 解决方案

**分离初始化和导航**:
1. XAML 中移除 `Source` 属性
2. 先调用 `EnsureCoreWebView2Async()` 初始化 WebView2
3. 初始化成功后，再设置 `Source` 属性导航到 HTML 页面
4. 添加 null 检查确保 `CoreWebView2` 不为 null

### 修改文件
- `src/Tai.App/Views/SankeyView.xaml` - 移除 Source 属性
- `src/Tai.App/Views/SankeyView.xaml.cs` - 代码中设置 Source，添加 null 检查

---

## 2026-02-16: Sankey 图导航未完成就开始渲染

### 问题描述
修复 CoreWebView2 空引用后，页面仍然空白，日志显示没有"导航完成"消息。

### 根因分析

**问题定位**:
1. 设置 `Source` 属性后立即调用 `RefreshDataAsync()`
2. HTML 页面可能还未加载完成
3. JavaScript 消息监听器还未注册
4. `PostWebMessageAsJson` 发送的数据无法被接收

### 解决方案

**使用 NavigationCompleted 事件**:
1. 注册 `NavigationCompleted` 事件处理器
2. 在导航完成后才设置 `_isWebViewInitialized = true`
3. 在导航完成后才调用 `RefreshDataAsync()`
4. 添加导航状态日志

### 修改文件
- `src/Tai.App/Views/SankeyView.xaml.cs` - 添加 NavigationCompleted 事件处理
- `src/Tai.App/Assets/Sankey/sankey.html` - 增强日志输出

---

## 2026-02-16: Sankey 图 HTML 文件导航失败

### 问题描述
日志显示 `NavigationCompleted，IsSuccess: false, HttpStatusCode: 0`，HTML 页面无法加载。

### 根因分析

**日志证据**:
```
[SankeyView] NavigationCompleted，IsSuccess: false, HttpStatusCode: 0
[ERR] [SankeyView] 导航失败
```

**问题定位**:
1. 项目配置为非打包应用 (`EnableMsixTooling=false`, `WindowsPackageType=None`)
2. `ms-appx-web:///` 协议仅在 MSIX 打包应用中可用
3. 非打包应用需要使用本地文件路径

### 解决方案

**使用本地文件路径**:
```csharp
var htmlPath = Path.Combine(
    AppDomain.CurrentDomain.BaseDirectory,
    "Assets", "Sankey", "sankey.html");
ChartWebView.Source = new Uri(htmlPath);
```

### 修改文件
- `src/Tai.App/Views/SankeyView.xaml.cs` - 改用本地文件路径

---

## 2026-02-16: ECharts CDN 被跟踪保护阻止

### 问题描述
浏览器控制台显示：
```
Tracking Prevention blocked access to storage for `https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js`
```

### 根因分析
1. WebView2 使用 Edge 浏览器内核
2. Edge 的跟踪保护功能阻止了 jsdelivr CDN
3. 导致 ECharts 库无法加载，图表无法渲染

### 解决方案
将 ECharts 下载到本地，使用相对路径引用：
1. 下载 `echarts.min.js` 到 `Assets/Sankey/` 目录
2. 修改 HTML 引用：`<script src="echarts.min.js"></script>`
3. 项目文件已配置 `Assets\Sankey\**\*` 复制到输出目录

### 修改文件
- `src/Tai.App/Assets/Sankey/echarts.min.js` - 新增 ECharts 库文件
- `src/Tai.App/Assets/Sankey/sankey.html` - 改用本地引用

---

## 2026-02-16: Sankey 图页面空白与刷新卡死问题

### 问题描述
应用流向页面在加载时显示为空白，且在用户点击刷新按钮后出现界面卡死现象。

### 根因分析

1. **WebView2 初始化时序问题**
   - 问题: `EnsureCoreWebView2Async()` 调用后未等待初始化完成就执行后续操作
   - 影响: 页面空白，JavaScript 无法执行

2. **UI 线程阻塞**
   - 问题: `LoadDataAsync()` 中直接设置属性，未使用 Dispatcher
   - 影响: 界面卡死，用户无法交互

3. **重复请求未防护**
   - 问题: 点击刷新按钮时未检查是否正在加载
   - 影响: 重复点击导致多次并发请求，加剧卡顿

4. **JavaScript 执行无错误处理**
   - 问题: `ExecuteScriptAsync` 调用无 try-catch，无法诊断问题
   - 影响: 无法定位 JavaScript 执行失败原因

5. **JSON 特殊字符问题**
   - 问题: 应用名称可能包含特殊字符导致 JavaScript 解析失败
   - 影响: 图表渲染失败

### 解决方案

1. **WebView2 初始化优化**
   - 添加 `_isWebViewInitialized` 标志防止重复初始化
   - 添加 Unloaded 事件处理释放资源
   - 添加初始化失败的错误提示

2. **UI 线程安全**
   - 使用 `RunOnUIThread()` 方法确保属性设置在 UI 线程执行
   - 添加详细的日志记录便于调试

3. **防重复请求**
   - 添加 `_isLoading` 标志防止重复请求
   - 在刷新按钮点击时检查加载状态

4. **JavaScript 错误处理**
   - 添加 WebMessageReceived 事件接收 JavaScript 消息
   - 添加 console.log 输出便于调试
   - 添加空数据状态显示

5. **JSON 安全处理**
   - 使用 `JavaScriptEncoder.UnsafeRelaxedJsonEscaping` 处理特殊字符
   - 添加 JSON 字符串转义

### 修改文件
- `src/Tai.App/Views/SankeyView.xaml.cs` (重写)
- `src/Tai.App/ViewModels/SankeyViewModel.cs` (优化)
- `src/Tai.App/Assets/Sankey/sankey.html` (增强错误处理)

---

## 2026-02-16: Sankey 图可视化功能

### 功能描述
在分析页面新增"应用流向"标签页，使用 Sankey 图可视化展示应用之间的切换流向。

### 遇到的问题

1. **CalendarDatePicker 绑定类型不匹配**
   - 错误: `Cannot directly bind type 'System.DateTime' to 'System.Nullable(System.DateTimeOffset)'`
   - 原因: `CalendarDatePicker.Date` 属性是 `DateTimeOffset?` 类型
   - 解决: 将 ViewModel 中的 `DateTime` 改为 `DateTimeOffset`

2. **WebView2 类型冲突**
   - 错误: `CoreWebView2` 类型同时存在于 `Microsoft.Web.WebView2.Core.Projection` 和 `Microsoft.WinUI`
   - 原因: WinUI 3 已内置 WebView2 控件，不需要单独引用 WebView2 包
   - 解决: 移除 `Microsoft.Web.WebView2` 包引用

### 实现方案

1. **使用 WebView2 + ECharts 实现**
   - 创建 sankey.html 作为 ECharts 渲染模板
   - 支持悬停显示详细信息、缩放拖动

2. **创建 SankeyViewModel**
   - 管理日期范围和 Top N 选择
   - 数据序列化为 JSON 传递给 ECharts

3. **创建 SankeyView UserControl**
   - 可复用的图表组件
   - 嵌入到 AnalyticsPage 的 Pivot 中

4. **修改 AnalyticsPage 结构**
   - 将原有内容包装到 Pivot 中
   - 新增"应用流向"标签页

### 修改文件
- `src/Tai.App/Assets/Sankey/sankey.html` (新增)
- `src/Tai.App/ViewModels/SankeyViewModel.cs` (新增)
- `src/Tai.App/Views/SankeyView.xaml` (新增)
- `src/Tai.App/Views/SankeyView.xaml.cs` (新增)
- `src/Tai.App/Views/AnalyticsPage.xaml` (修改)
- `src/Tai.App/Services/ServiceConfiguration.cs` (修改)
- `src/Tai.App/Tai.App.csproj` (修改)

### 功能特性
- 支持自定义日期范围
- 支持调整 Top N 应用数量
- 悬停显示详细信息
- 支持缩放和拖动
- 自动适应深色/浅色主题

---

## 2026-02-16: 时间线按小时分组与按需加载优化

### 问题描述
时间线页面虽然进行了初步优化，但在数据量较大时仍有卡顿现象。用户请求将时间线改为按小时分组显示，默认只展开最近一小时，其余时段按需加载。

### 解决方案

1. **新增 TimelineHourGroup 数据模型**
   - 按小时分组显示活动记录
   - 支持 IsExpanded/IsLoaded 状态控制
   - 显示时段范围、活动数量、总时长

2. **重构 LoadDataAsync 方法**
   - 按小时分组查询结果
   - 倒序排列（最新时段在前）
   - 默认只加载当前小时（或最新时段）的活动详情
   - 其他时段只显示摘要信息

3. **实现按需加载机制**
   - 新增 ExpandHourGroupAsync 方法
   - 用户展开时段时才查询该时段的详细数据
   - 图标按组异步加载

4. **优化时长格式化**
   - 新增 FormatDuration 方法
   - 支持秒级显示（短时长）
   - 智能显示小时/分钟

5. **更新 XAML 界面**
   - 使用 Expander 控件实现可折叠时段
   - 时段标题显示时间范围、活动数、总时长
   - 展开时触发按需加载

6. **清理旧代码**
   - 移除 TimelineGroup 类（被 TimelineHourGroup 替代）
   - 移除旧的时段分组逻辑

### 修改文件
- `src/Tai.App/ViewModels/TimelineViewModel.cs`
- `src/Tai.App/Views/TimelinePage.xaml`
- `src/Tai.App/Views/TimelinePage.xaml.cs`

### 效果
- 初始加载只渲染当前时段数据，大幅提升加载速度
- 用户可按需查看历史时段，减少不必要的内存占用
- UI 更加清晰，时段信息一目了然

---

## 2026-02-16: 时间线页面卡顿优化

### 问题描述
时间线页面在加载大量活动记录时出现明显卡顿，UI 响应缓慢。

### 问题分析

经过系统性调试，发现以下多个性能问题：

1. **内层 ItemsControl 不支持虚拟化（主要原因）**
   - 位置: `TimelinePage.xaml`
   - 外层 `ListView` 虽然启用了 `VirtualizingStackPanel`，但内层 `ItemsControl` 不支持虚拟化
   - 当一天有大量活动记录时，所有活动项都会被一次性完整渲染

2. **图标批量更新阻塞 UI 线程**
   - 位置: `TimelineViewModel.cs`
   - 图标加载虽然在后台线程，但更新 `activity.Icon` 会触发 `INotifyPropertyChanged`
   - 大量 UI 更新请求排队等待 UI 线程处理

3. **EF Core 查询未使用 AsNoTracking**
   - 位置: `TimelineViewModel.cs`
   - 查询时 EF Core 会跟踪所有实体，增加内存分配和 GC 压力

4. **ObservableCollection 操作触发多次 UI 重绘**
   - `Clear()` + 多次 `Add()` 会触发多次 `CollectionChanged` 事件
   - 导致 UI 反复重绘

### 解决方案

1. **将内层 ItemsControl 改为 ListView**
   ```xml
   <ListView
       ItemsSource="{x:Bind Activities}"
       ScrollViewer.IsDeferredScrollingEnabled="True"
       SelectionMode="None"
       IsItemClickEnabled="False">
       <ListView.ItemsPanel>
           <ItemsPanelTemplate>
               <VirtualizingStackPanel />
           </ItemsPanelTemplate>
       </ListView.ItemsPanel>
       ...
   </ListView>
   ```

2. **使用 AsNoTracking() 优化数据库查询**
   ```csharp
   appSessions = await _dbContext.AppSessions
       .AsNoTracking()
       .Where(s => s.StartTime >= selectedDate && s.StartTime < nextDay)
       .OrderBy(s => s.StartTime)
       .ToListAsync();
   ```

3. **批量更新 ObservableCollection**
   - 先创建新集合，再一次性 Clear + Add
   - 减少中间状态的 UI 重绘

4. **优化图标更新机制**
   - 使用 DispatcherQueue 分批更新图标
   - 每批 10 个图标，使用低优先级避免阻塞 UI
   - 批次间添加 16ms 延迟，保持 UI 响应性

### 修改文件
- `src/Tai.App/Views/TimelinePage.xaml`
- `src/Tai.App/ViewModels/TimelineViewModel.cs`

### 效果
- 大幅减少初始加载时间
- 滚动时 UI 更加流畅
- 内存占用降低（无实体跟踪开销）

---

## 2026-02-16: Sankey 图日期选择卡死与同一天无数据问题

### 问题描述
1. 选择开始日期为15日，结束日期为15日时，显示"暂无数据"
2. 再次选择结束日期为当前已选择的日期时，程序卡死

### 根因分析

1. **同一天无数据问题**
   - 问题: 开始和结束时间完全相同（如 `2026-02-15 22:11:30`）
   - 原因: 查询范围是 `StartTime >= startDateTime && StartTime <= endDateTime`
   - 当开始和结束时间相同时，查询范围几乎为零

2. **程序卡死问题**
   - 问题: 日期选择器多次触发刷新请求
   - 原因: WinUI 3 CalendarDatePicker 在选择日期时会触发多次 PropertyChanged 事件
   - 日志显示短时间内触发了多次 RefreshDataAsync

### 解决方案

1. **日期范围计算优化**
   ```csharp
   var startDateTime = StartDate.DateTime.Date;  // 当天 00:00:00
   var endDateTime = EndDate.DateTime.Date.AddDays(1).AddSeconds(-1);  // 当天 23:59:59
   ```
   - 选择同一天时，查询范围是当天全天

2. **移除自动刷新**
   - 只保留手动刷新按钮
   - 避免日期选择器多次触发导致的卡死

### 修改文件
- `src/Tai.App/ViewModels/SankeyViewModel.cs` - 日期范围计算
- `src/Tai.App/Views/SankeyView.xaml.cs` - 移除自动刷新

---

## 2026-02-16: Sankey 图 NavigationCompleted 事件处理

### 问题描述
使用硬编码 `Task.Delay(800)` 等待页面加载，没有检查导航是否成功，页面加载失败时无法感知。

### 解决方案

1. **注册 NavigationCompleted 事件**
   ```csharp
   ChartWebView.CoreWebView2.NavigationCompleted += CoreWebView2_NavigationCompleted;
   ```

2. **在导航完成后才加载数据**
   ```csharp
   private async void CoreWebView2_NavigationCompleted(...)
   {
       if (!args.IsSuccess)
       {
           ViewModel.SummaryText = "图表页面加载失败";
           return;
       }
       _isWebViewInitialized = true;
       await RefreshDataAsync();
   }
   ```

3. **添加导航状态标志**
   - 使用 `_isNavigating` 标志防止重复处理

### 修改文件
- `src/Tai.App/Views/SankeyView.xaml.cs`

---

## 2026-02-16: Sankey 图 ECharts 渲染错误 dataIndex

### 问题描述
日志显示 JavaScript 错误：`"error: Cannot set properties of undefined (setting 'dataIndex')"`，图表显示空白。

### 根因分析

**日志证据**:
```
[SankeyView] JavaScript 执行结果: "error: Cannot set properties of undefined (setting 'dataIndex')"
```

**问题定位**:
1. 使用 `chart.setOption({...}, true)` 时传入了第二个参数 `notMerge=true`
2. 这会导致 ECharts 完全替换配置而不是合并
3. 可能导致内部状态不一致，引发 `dataIndex` 相关错误

### 解决方案

1. **移除 notMerge 参数**
   ```javascript
   // 之前
   chart.setOption({...}, true);
   
   // 之后
   chart.clear();
   chart.setOption({...});
   ```

2. **使用 clear() 方法**
   - 在设置新配置前先调用 `chart.clear()` 清空图表
   - 确保完全重置状态，避免旧配置干扰

### 修改文件
- `src/Tai.App/Assets/Sankey/sankey.html`

---

## 2026-02-16: Sankey 图完全销毁重建实例

### 问题描述
即使使用 clear() 方法，仍然出现 `Cannot set properties of undefined (setting 'dataIndex')` 错误。

### 根因分析

`chart.clear()` 可能仍有残留状态导致内部错误。

### 解决方案

**完全销毁并重建图表实例**：
```javascript
function disposeChart() {
    if (chart) {
        chart.dispose();
        chart = null;
        if (resizeHandler) {
            window.removeEventListener('resize', resizeHandler);
            resizeHandler = null;
        }
    }
}

// 在 renderSankey 中
disposeChart();
initChart();
chart.setOption({...});
```

### 修改文件
- `src/Tai.App/Assets/Sankey/sankey.html` - 完全重建图表实例

---

## 2026-02-16: 验证 ECharts 基本功能并恢复完整功能

### 问题描述
通过测试简单的 Sankey 图验证了 ECharts 和 WebView2 配置正常。

### 解决方案

1. **验证基本功能**：使用静态数据创建简单的 Sankey 图，确认渲染正常
2. **恢复完整功能**：基于验证结果，重新实现完整的 Sankey 图功能
3. **使用 notMerge=true**：确保每次渲染都是全新的配置

### 修改文件
- `src/Tai.App/Assets/Sankey/sankey.html` - 恢复完整功能，使用安全的渲染方式

---

## 2026-02-16: 修复 SankeyAggregator 数据传递问题

### 问题描述
Sankey 图显示空白，JavaScript 执行返回 `null` 或 `Cannot set properties of undefined (setting 'dataIndex')` 错误。

### 根因分析

1. **Other 节点可能不存在**：当 `otherUsage` 为零时，不会创建 "Other" 节点，但 transitions 处理时可能引用 `nodeIdMap["Other"]`
2. **nodeMap 缺少 ID 映射**：links 中的 sourceId/targetId 可能在 nodeMap 中找不到对应名称
3. **使用 `topApps.Contains()` 判断不可靠**：某些 processName 可能不在 topApps 中但也不应该映射到 Other

### 解决方案

**修改 SankeyAggregator.cs**：
```csharp
// 始终创建 Other 节点
var otherId = Guid.NewGuid().ToString();
nodes.Add(new SankeyNode
{
    Id = otherId,
    Name = "其他应用",
    ProcessName = "Other",
    TotalUsage = otherUsage
});
nodeIdMap["Other"] = otherId;

// 使用 TryGetValue 安全获取 ID
var sourceId = nodeIdMap.TryGetValue(source, out var sId) ? sId : nodeIdMap["Other"];
var targetId = nodeIdMap.TryGetValue(target, out var tId) ? tId : nodeIdMap["Other"];
```

**修改 sankey.html**：
- 添加详细的数据验证和错误日志
- 在渲染前检查每个 link 的 sourceId/targetId 是否有效

### 修改文件
- `src/Tai.Application/Aggregators/SankeyAggregator.cs` - 修复节点映射逻辑
- `src/Tai.App/Assets/Sankey/sankey.html` - 添加详细错误日志

---

## 2026-02-16: 修复 ECharts 初始化问题导致空白页面

### 问题描述
1. 页面依旧空白
2. 选择结束日期时会卡死（当选择结束日期为已经选择的同一天时）

### 根因分析

1. **ECharts 初始化时机问题**：页面加载时立即初始化图表，但 DOM 可能未完全准备好，导致 `Cannot set properties of undefined (setting 'dataIndex')` 错误
2. **图表实例残留**：重复渲染时，旧的图表实例状态未完全清除

### 解决方案

**修改 sankey.html**：
```javascript
function initChart() {
    // 每次渲染前先销毁旧实例
    if (chart) {
        try { chart.dispose(); } catch(e) {}
        chart = null;
    }
    
    // 重新初始化
    chart = echarts.init(chartDom);
    return 'initialized';
}

function renderSankey(data) {
    // 每次渲染都重新初始化图表
    var initResult = initChart();
    if (initResult !== 'initialized') {
        return initResult;
    }
    
    // 设置配置
    chart.setOption({...}, true);
    
    // 延迟 resize 确保 DOM 更新
    setTimeout(function() {
        if (chart) chart.resize();
    }, 100);
}
```

### 修改文件
- `src/Tai.App/Assets/Sankey/sankey.html` - 每次渲染前重新初始化图表

---

## 2026-02-16: 修复节点名称重复导致 ECharts 渲染失败

### 问题描述
Sankey 图渲染失败，错误信息：`Cannot set properties of undefined (setting 'dataIndex')`

### 根因分析

通过日志发现 JSON 数据中存在**节点名称重复**：
```json
{"nodes":[{"name":"Doubao"},{"name":"Doubao"},{"name":"Trae CN"},{"name":"Trae CN"}...]}
```

ECharts Sankey 图不支持重复的节点名称，导致内部渲染失败。

### 解决方案

**修改 SankeyAggregator.cs**：
```csharp
var nodeNameSet = new HashSet<string>();

// 确保节点名称唯一
var uniqueName = displayName;
var counter = 1;
while (nodeNameSet.Contains(uniqueName))
{
    uniqueName = $"{displayName}_{counter}";
    counter++;
}
nodeNameSet.Add(uniqueName);
```

### 修改文件
- `src/Tai.Application/Aggregators/SankeyAggregator.cs` - 确保节点名称唯一

---

## 2026-02-16: Sankey 图问题排查记录

### 已尝试的方法

| 序号 | 尝试方法 | 结果 | 原因分析 |
|------|---------|------|---------|
| 1 | 使用 `chart.clear()` 清除旧配置 | ❌ 失败 | ECharts 内部状态残留 |
| 2 | 使用 `chart.dispose()` 销毁重建 | ❌ 失败 | DOM 未完全准备好 |
| 3 | 使用 `notMerge=true` 参数 | ❌ 失败 | 数据本身有问题 |
| 4 | 添加 DOMContentLoaded 事件 | ❌ 失败 | WebView2 加载时机问题 |
| 5 | 增加 Task.Delay 延迟 | ❌ 失败 | 不是时机问题 |
| 6 | 简化数据格式（移除 ID 映射） | ❌ 失败 | 数据本身有问题 |
| 7 | **修复节点名称重复** | ✅ 部分成功 | 节点名称唯一后，发现新问题 |

### 发现的问题

1. **节点名称重复**：`Doubao`、`Trae CN`、`PChabit` 等名称重复出现
   - 解决：添加 `_1`, `_2` 后缀确保唯一

2. **数据存在循环**：`Sankey is a DAG, the original data has cycle!`
   - 原因：应用切换数据中存在双向切换（A→B 和 B→A）
   - 解决：合并双向链接

---

## 2026-02-16: 修复 Sankey 图循环数据问题

### 问题描述
修复节点名称重复后，出现新错误：`Sankey is a DAG, the original data has cycle!`

### 根因分析

Sankey 图是有向无环图(DAG)，但应用切换数据中存在循环：
- A→B 和 B→A 同时存在
- 例如：`Doubao→explorer` 和 `explorer→Doubao`

### 解决方案

合并双向链接，只保留一个方向，值为两者之和：
```csharp
// 将 A→B 和 B→A 合并为 A↔B，只保留一个方向
```

---

## 2026-02-16: 在数据收集阶段标准化进程名

### 问题描述
合并双向链接后，仍然报错 `Sankey is a DAG, the original data has cycle!`

### 根因分析

日志显示 `Doubao` 和 `Doubao_1` 是不同的节点，但它们代表同一个应用：
- 原始数据中有 `Doubao.exe` 和 `Doubao` 两个进程名
- 在最后才处理名称重复，导致同一个应用被分成多个节点
- 这些节点之间形成循环

### 解决方案

**在数据收集阶段就标准化进程名**：
```csharp
// 在统计 appUsage 时就使用标准化名称
var processName = GetAppDisplayName(session.ProcessName ?? "Unknown");
```

这样 `Doubao.exe` 和 `Doubao` 会被合并为同一个应用，避免循环。

### 修改文件
- `src/Tai.Application/Aggregators/SankeyAggregator.cs` - 在数据收集阶段标准化进程名

---

## 2026-02-16: 将 Sankey 图改为力导向图

### 问题描述
即使修复了节点名称重复和数据收集阶段的标准化，仍然报错 `Sankey is a DAG, the original data has cycle!`

### 根因分析

**Sankey 图本质上是有向无环图(DAG)，不支持任何形式的循环。**

应用切换数据天然包含循环：
```
PChabit → Trae CN → Doubao → explorer → 其他应用 → PChabit
```

用户在应用之间来回切换是正常行为，无法避免循环。

### 解决方案

**改用力导向图（Graph）**：
- 力导向图支持循环数据
- 节点大小可以表示使用时长
- 连线粗细可以表示切换次数
- 支持拖拽和缩放交互

### 修改文件
- `src/Tai.App/Assets/Sankey/sankey.html` - 改用力导向图
- `src/Tai.App/ViewModels/SankeyViewModel.cs` - 添加 value 和 category 字段

---

## 2026-02-17: 修复 Base64 编码导致图表不显示的问题

### 问题描述
力导向图静态测试成功，但动态数据渲染时只显示图例，不显示节点和连线。JavaScript 执行返回成功，但图表为空。

### 根因分析

**Base64 编码/解码问题**：
- C# 端使用 `Convert.ToBase64String()` 编码 JSON
- JavaScript 端使用 `atob()` 解码
- `atob()` 在某些情况下可能无法正确处理 UTF-8 编码的中文字符
- 解码后的 JSON 可能包含乱码或格式错误，导致 ECharts 无法正确解析

### 解决方案

**改用直接转义字符串**：
```csharp
// 旧方法（有问题）
var base64Json = Convert.ToBase64String(Encoding.UTF8.GetBytes(json));
var script = $"renderSankey(JSON.parse(atob(\"{base64Json}\")));";

// 新方法（正确）
var escapedJson = json.Replace("\\", "\\\\").Replace("\"", "\\\"").Replace("\n", "\\n").Replace("\r", "\\r");
var script = $"renderSankey(JSON.parse(\"{escapedJson}\"));";
```

### 经验教训

1. **避免在 WebView2 中使用 Base64 编码传递中文数据**
   - `atob()` 只支持 ASCII 字符
   - UTF-8 编码的中文字符可能被错误解码

2. **推荐使用直接转义方式传递 JSON**
   - 简单可靠
   - 不涉及编码转换

3. **静态测试是排查问题的有效方法**
   - 先验证 ECharts 本身是否正常
   - 再排查数据传递问题

### 修改文件
- `src/Tai.App/Views/SankeyView.xaml.cs` - 改用直接转义字符串传递 JSON

---

## 2026-02-17: 优化力导向图视觉效果

### 优化内容

1. **节点样式优化**：
   - 添加白色边框和阴影效果
   - 节点大小根据使用时长动态计算
   - 标签字体加粗

2. **连线样式优化**：
   - 连线粗细根据切换次数动态计算
   - 连线颜色跟随源节点颜色
   - 添加曲线效果

3. **分类显示**：
   - 右侧显示分类图例
   - 支持点击图例筛选分类
   - 每个分类有独特的颜色

4. **交互优化**：
   - 鼠标悬停高亮相关节点和连线
   - 支持拖拽和缩放
   - 标签自动隐藏避免重叠

5. **标题和提示**：
   - 添加图表标题
   - 优化 tooltip 显示格式

### 修改文件
- `src/Tai.App/Assets/Sankey/sankey.html` - 优化视觉效果

---
